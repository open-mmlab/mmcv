version: 2.1
jobs:
  build_cu101:
    machine:
      image: ubuntu-1604-cuda-10.1:201909-23
    resource_class: gpu.nvidia.small
    steps:
      - checkout
      - run:
          name: Update PATH and Define Environment Variable at Runtime
          command: |
            echo 'export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH' >> $BASH_ENV
            echo 'export PATH=/usr/local/cuda/bin:$PATH' >> $BASH_ENV
            echo 'export CUDA_HOME=/usr/local/cuda' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Print relative CUDA information
          command: |
            nvidia-smi
            nvcc --version
      - run:
          name: Install Python-dev
          command: |
            which python
            ls /opt/circleci/.pyenv/shims/
            python --version
      - run:
          name: Upgrade pip
          command: python3.7 -m pip install pip --upgrade
      - run:
          name: Install PyTorch
          command: python3.7 -m pip install torch==1.8.0+cu102 torchvision==0.9.0+cu102 -f https://download.pytorch.org/whl/torch_stable.html
      - run:
          name: Install system dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y ffmpeg libturbojpeg ninja-build
      - run:
          name: Install psutil
          command: python3.7 -m pip install psutil
      - run:
          name: Build and install
          command: |
            rm -rf .eggs
            python3.7 setup.py check -m -s
            python3.7 -m pip install -e .
          environment:
            MMCV_WITH_OPS: 1
      - run:
          name: Install dependencies of unit test
          command: python3.7 -m pip install -r requirements/test.txt
      - run:
          name: Run unittests and generate coverage report
          command: |
            python3.7 -m pytest tests/
workflows:
  unit_tests:
    jobs:
      - build_cu101

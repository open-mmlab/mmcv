version: 2.1
jobs:
  build_cu101:
    environment:
      PYTHON_VERSION: "3.9"
    machine:
      image: ubuntu-1604-cuda-10.1:201909-23
    resource_class: gpu.nvidia.small
    steps:
      - checkout
      - run:
          name: Print relative CUDA information
          command: |
            nvidia-smi
            ls /usr/local
            /usr/local/cuda/bin/nvcc --version
      - run:
          name: Install Python-dev
          # command: apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends python${{matrix.python-version}}-dev
          command: |
            DEBIAN_FRONTEND=noninteractive sudo apt-get install -y python3.7
            python3.7 --version
      - run:
          name: Upgrade pip
          command: python3.7 -m pip install pip --upgrade
      - run:
          name: Install PyTorch
          command: python3.7 -m pip install torch==1.8.0+cu101 torchvision==0.9.0+cu101 -f https://download.pytorch.org/whl/torch_stable.html
      - run:
          name: Install system dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y ffmpeg libturbojpeg ninja-build
      - run:
          name: Install dependencies for compiling onnx when python=3.9
          command: |
            python3.7 -m pip install protobuf
            sudo apt-get -y install libprotobuf-dev protobuf-compiler cmake
      - run:
          name: Install psutil
          command: python3.7 -m pip install psutil
      - run:
          name: Build and install
          command: |
            rm -rf .eggs
            python3.7 setup.py check -m -s
            python3.7 -m pip install -e .
          environment:
            MMCV_WITH_OPS: 1
      - run:
          name: Install dependencies of unit test
          command: python3.7 -m pip install -r requirements/test.txt
      - run:
          name: Run unittests and generate coverage report
          command: |
            python3.7 -m pytest tests/
workflows:
  unit_tests:
    jobs:
      - build_cu101

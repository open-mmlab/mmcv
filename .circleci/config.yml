version: 2.1
jobs:
  build_cu101:
    environment:
      PYTHON_VERSION: "3.9"
    machine:
      image: ubuntu-1604:202104-01
    resource_class: gpu.nvidia.small
    steps:
      - checkout
      - run:
          name: Setup CUDA
          command: |
            wget https://developer.nvidia.com/compute/cuda/10.1/Prod/local_installers/cuda-repo-ubuntu1604-10-1-local-10.1.105-418.39_1.0-1_amd64.deb
            sudo dpkg -i cuda-repo-ubuntu1604-10-1-local-10.1.105-418.39_1.0-1_amd64.deb
            sudo apt-key add /var/cuda-repo-10.1/7fa2af80.pub
            sudo apt-get update
            sudo apt-get install cuda
            nvidia-smi
      - run:
          name: Add python3.9 source
          command: |
            sudo apt-get update
            sudo apt-get install -y software-properties-common
            sudo add-apt-repository -y ppa:deadsnakes/ppa
      # Install python-dev for some packages which require libpython3.Xm.
      # Github's setup-python cannot install python3.9-dev, so we have to use apt install.
      # Set DEBIAN_FRONTEND=noninteractive to avoid some interactions.
      - run:
          name: Install Python-dev
          # command: apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends python${{matrix.python-version}}-dev
          command: |
            DEBIAN_FRONTEND=noninteractive sudo apt-get install -y python3.9
            python3 --version
      - run:
          name: Upgrade pip
          command: python3 -m pip install pip --upgrade
      - run:
          name: Install PyTorch
          command: python3 -m pip install torch==1.8.0+cu101 torchvision==0.9.0+cu101 -f https://download.pytorch.org/whl/torch_stable.html
      - run:
          name: Install system dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y ffmpeg libturbojpeg ninja-build
      - run:
          name: Install dependencies for compiling onnx when python=3.9
          command: |
            python3 -m pip install protobuf
            sudo apt-get -y install libprotobuf-dev protobuf-compiler cmake
      - run:
          name: Install psutil
          command: python3 -m pip install psutil
      - run:
          name: Build and install
          command: |
            rm -rf .eggs
            python3 setup.py check -m -s
            python3 -m pip install -e .
          environment:
            MMCV_WITH_OPS: 1
      - run:
          name: Install dependencies of unit test
          command: python3 -m pip install -r requirements/test.txt
      - run:
          name: Run unittests and generate coverage report
          command: |
            coverage run --branch --source mmcv -m pytest tests/
            coverage xml
            coverage report -m
workflows:
  unit_tests:
    jobs:
      - build_cu101
